# データベース容量試算 (Database Capacity Estimation) v3.0

**目的:** 70,000記事 × **7言語** (JA, EN, DE, FR, IT, ES, ZH) = 490,000エントリー を収容するための試算。

## 1. 結論: Free Tier (500MB) では不可能
7言語展開を前提とした場合、テキストデータとインデックスだけで **約900MB** に達し、ベクトル検索を一切使わなくても無料枠を超過する。
したがって、以下の **段階的拡張戦略 (Staged Growth Strategy)** を採用する。

### 戦略 A: "Pay to Grow" (推奨)
7言語すべてを最初からリリースする場合、初月から **Supabase Pro Tier ($25/mo, 8GB)** を契約する。
ビジネス規模（7万記事×7言語）を考えれば、月額$25は許容すべき必要経費である。

### 戦略 B: "Lean Launch" (無料枠維持プラン)
どうしても無料枠で開始する場合、以下の初期制限を設ける。
1.  **Language Limit:** ローンチ時は **JA / EN の2言語のみ** とする（他言語はMDX生成のみ行いR2に保存、DBには入れない）。
2.  **Content Limit:** DB化する記事を「主要1万作品」に絞る（Long-tailは静的HTMLのみで提供し、検索対象外とする）。

**本ドキュメントでは「戦略 A（将来的なPro移行）」を前提としつつ、初期フェーズではJA/ENを中心に運用する想定で試算を残す。**

---

## 2. 詳細内訳 (7 Languages / Full Scale check)

### 2.1 テーブルデータ (Row Data)
前提: 70,000作品 × 7言語 = 490,000 翻訳レコード。

| テーブル | 行数 | 単価 | 合計 |
| :--- | :--- | :--- | :--- |
| **articles** | 70k | 100 B | **7 MB** |
| **article_translations** | **490k** | 1.0 KB | **490 MB** |
| **scores / recordings** | 70k | 0.5 KB | **35 MB** |
| **Subtotal (Data)** | | | **532 MB** (既にOver) |

### 2.2 インデックス
| 種類 | 件数 | 単価 | 合計 |
| :--- | :--- | :--- | :--- |
| **B-Tree / GIN** | **490k** | 0.4 KB | **196 MB** |

### 2.3 ベクトルデータ (JA only)
| 種類 | 件数 | 単価 | 合計 |
| :--- | :--- | :--- | :--- |
| **HNSW (JA)** | 70k | 2.5 KB | **175 MB** |

### 3. 総合計 (Full Scale)
**合計推定: 約 900 MB ~ 1.0 GB**
-> Free Tier (500MB) の **約200%** となる。

### 今後のアクションプラン
1.  **監視 (Monitoring):** 運用開始後、ダッシュボードで容量推移を週次監視する。
2.  **アーカイブ (Archiving):** 450MBを超えた時点で、アクセス頻度の低い「ドラフト記事」や「古いバージョン」を削除、またはCold Storage (R2) へ退避する機能を実装する。
3.  **Pro Tier移行:** 収益化の目処が立った段階で、月額$25のPro Tierへ移行する（容量8GB）。これが最も健全な長期的解決策である。

**目的:** 70,000記事を **Supabase Free Tier (500 MB)** 内に収容可能か検証する。

## 1. 結論: 500MB制限への対策
7万記事を500MBで管理するためには、以下の戦略が **必須** である。

1.  **Split-Storage:** 記事本文 (MDX) はデータベースに入れず、Object Storage (R2) へ逃がす。
2.  **Half-Precision:** ベクトル検索には軽量な `halfvec` (16-bit) を使用する（Float32は容量オーバー）。
3.  **Summary Only:** 全文検索対象は「要約」に絞る（本文全文のインデックス化は不可）。

**結果:** 推定合計サイズ = **約 370 MB** (✅ 安全圏)

---

## 2. 詳細内訳

### 2.1 テーブルデータ (行データ)
MDX本文は除外。メタデータ、楽譜、要約のみをDBに格納する。

| 項目 | 1行あたり | 70k件合計 | 備考 |
| :--- | :--- | :--- | :--- |
| **Metadata** | 0.2 KB | 14 MB | ID(UUID), Slug, Title 等 |
| **Summary** | 1.0 KB | 70 MB | 一覧表示および検索用 |
| **Scores** | 0.5 KB | 35 MB | ABC/MusicXML (テキストデータ) |
| **Content Body** | - | **0 MB** | **R2へオフロード** |
| **Table Total** | | **119 MB** | |

### 2.2 Vector Embeddings (ベクトルデータ)
標準の `float32` では容量不足となるため、`halfvec` を採用する。

| 型 | データサイズ | データ合計 | インデックス (HNSW) | 合計インパクト |
| :--- | :--- | :--- | :--- | :--- |
| **Float32** | 3 KB | 210 MB | ~210 MB | **420 MB** (❌ 不可) |
| **Halfvec** | 1.5 KB | **105 MB** | **~100 MB** | **205 MB** (✅ 可能) |

### 2.3 合計容量
| カテゴリ | サイズ |
| :--- | :--- |
| **テーブルデータ** | 119 MB |
| **標準インデックス** (B-Tree/GIN) | 45 MB |
| **ベクトルデータ + インデックス** (`halfvec`) | 205 MB |
| **総合計** | **369 MB** |

## 3. ID戦略 (UUID v7 & Base64)
**決定: UUID v7 を採用する。**

- **容量差:** Integer比でわずか **~0.8 MB** (0.16%) の増加であり、無視できる。
- **メリット:**
  - **v7 (Time-ordered):** 時系列ソートが可能で、インデックス効率が良い（ランダムUUIDの欠点を解消）。
  - **Base64:** ストレージキーとして使う際、Base64エンコードでcompactに扱える。
